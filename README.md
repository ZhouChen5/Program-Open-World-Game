# 《游戏项目实验报告：类原神的幻兽帕鲁游戏设计》
基于幻兽帕鲁风格的大世界探险游戏开发项目
## 一、项目背景与目标
&nbsp;&nbsp;&nbsp;&nbsp;本游戏采用UE5.4进行开发，项目旨在打造一个富有深度和沉浸感的游戏世界，通过多方面的创新设计与技术攻克，为玩家带来独特的游戏体验。在遵循程序设计范式的基础上，团队聚焦于主世界构建、玩家交互体验提升以及特色角色（帕鲁）AI 系统的深度开发，致力于突破传统游戏开发的局限，实现一系列具有挑战性的功能特性。
## 二、主世界创新技术实现
### （一）Steam 联机功能
&nbsp;&nbsp;&nbsp;&nbsp;在 UE 中实现联机功能并连接到 Steam，首先需要集成 Steamworks SDK。通过在项目设置中配置相关的库文件和头文件路径，确保 UE 项目能够正确引用 Steamworks 的功能接口。利用 UE 的 OnlineSubsystem 框架来构建联机基础架构，在其中创建 Steam 作为联机服务提供商的特定实例。  
&nbsp;&nbsp;&nbsp;&nbsp;在网络连接初始化时，使用 Steamworks API 提供的函数来处理网络协议配置，例如设置加密密钥交换机制，通过 Steam 的加密服务确保玩家数据在传输过程中的安全性，防止数据被窃取或篡改。对于玩家状态信息同步，借助 UE 的网络复制功能结合 Steam 的网络通信能力，将玩家的位置、动画状态、生命值等关键数据在服务器和客户端之间进行可靠传输。利用状态机来管理玩家状态的变化，并在客户端进行预测和校正，以减少网络延迟带来的视觉差异。同时，采用数据压缩算法对同步数据进行处理，UE 中可利用内置的压缩库或者 Steam 推荐的压缩方式，减少网络带宽占用，确保联机游戏的流畅性，即使在网络条件不佳的情况下也能提供稳定的游戏体验。
### （二）天气和时间系统
&nbsp;&nbsp;&nbsp;&nbsp;在 UE 中构建天气和时间系统时，首先利用其强大的蓝图可视化编程功能与 C++ 代码相结合的方式。对于天气系统，通过创建基于物理的材质和粒子系统来模拟各种天气现象。例如，在模拟降雨时，运用粒子系统生成雨滴粒子，并设置其速度、大小、密度等参数，使其在重力作用下自然下落，同时利用材质的反射和折射属性来呈现雨滴在不同光照条件下的视觉效果。通过蓝图节点来控制天气效果的触发与切换，例如根据时间系统或者特定游戏事件来启动或停止降雨、降雪等天气效果。  
&nbsp;&nbsp;&nbsp;&nbsp;时间系统则借助 UE 的定时器和时间轴功能实现。设置全局定时器来精确追踪游戏内时间流逝，依据真实时间比例或自定义的游戏时间流速进行计时。利用时间轴功能来规划不同时间段内的光照变化、环境音效切换等事件。比如，在白天时段，逐渐增强光照强度并播放鸟鸣等自然音效；随着夜晚降临，降低光照亮度，切换到静谧的夜间音效，并可能触发一些特定于夜晚的游戏事件或 AI 行为，如怪物的活跃或 NPC 的休息，从而使天气和时间系统紧密融合，为游戏世界营造出高度真实且动态变化的环境氛围。
### （三）地图渲染与构建
&nbsp;&nbsp;&nbsp;&nbsp;在 UE 中实现地图渲染与构建可借助多种插件和内置功能。对于地形生成，可使用 World Machine 等地形生成插件与 UE 协同工作。在 World Machine 中根据设计需求创建高度图和纹理图，然后将其导入到 UE 中作为地形的基础数据。UE 会依据这些数据利用其地形系统生成具有真实感的地形地貌，并且可以进一步通过地形材质编辑功能，使用基于物理的渲染（PBR）材质来表现不同地形表面的质感，如岩石、草地、泥土等。  
&nbsp;&nbsp;&nbsp;&nbsp;对于地图元素的构建，如建筑物、道具等，可以使用 UE 的建筑建模插件或者直接在 UE 的编辑器中进行创建。利用蓝图可视化脚本功能为这些地图元素添加交互逻辑，例如门的开关、宝箱的开启等。在渲染方面，UE 的光照系统发挥关键作用，通过设置静态光照烘焙或者动态光照，结合光影追踪技术（若硬件支持），营造出逼真的光照效果，使地图在不同时间和天气条件下都能呈现出丰富的视觉层次。同时，运用 UE 的 LOD（细节层次）系统，根据相机与地图元素的距离自动切换不同精度的模型和材质，优化渲染性能，确保大规模地图在游戏运行过程中的流畅性和高效性。
### （四）主界面UI的设计
&nbsp;&nbsp;&nbsp;&nbsp;在 UE 中实现地图渲染与构建可借助多种插件和内置功能。游戏主界面作为核心枢纽，布局设计注重简洁与直观。采用大图标与清晰文字标识各个功能模块，如开始游戏、设置选项、存档管理等。通过蓝图实现按钮点击事件的响应，例如点击开始游戏后，进行游戏初始化流程的调用与场景切换。主界面的背景与装饰元素选取贴合游戏主题的材质与纹理。
### （五）背包系统的设计
&nbsp;&nbsp;&nbsp;&nbsp;在 UE 中设计背包系统，首先构建合理的数据结构。定义物品类，包含物品名称、类型（武器、防具、消耗品等）、图标资源引用、属性加成（如攻击力、防御力、生命值恢复量等）、堆叠数量上限等成员变量。采用数组或链表来存储玩家背包中的物品实例。
在物品的添加功能方面，当玩家拾取物品时，通过碰撞检测确定物品类型与数量，然后创建对应的物品实例并添加到背包数组中。利用蓝图或 C++ 函数实现物品数量的限制与堆叠逻辑，若物品可堆叠且背包中已有相同物品，则增加其数量，否则创建新的物品实例。背包系统与 UI 紧密结合，采用数据绑定技术。当背包中物品数据发生变化（添加、移除、使用等）时，通过蓝图的事件分发机制通知 UI 更新显示。同时，UI 中的操作（如整理背包功能）也通过函数调用作用于背包数据结构，实现数据与界面的双向交互，确保玩家在游戏过程中能够方便、快捷地管理自己的背包物品，为游戏的资源管理与角色成长提供有力支撑。
## 三、玩家交互功能创新技术实现
### （一）流畅动作设计
&nbsp;&nbsp;&nbsp;&nbsp;玩家动作的流畅性通过先进的骨骼动画技术与无缝过渡算法得以保障。在骨骼动画系统中，为玩家角色创建的骨骼结构包含超过 50 个骨骼节点，每个节点的运动控制都需要精确的数学计算。动画制作软件生成的动作动画数据在导入游戏引擎后，设计了动画数据解析与播放代码，用于将动画数据转换为角色骨骼的实时运动。  
&nbsp;&nbsp;&nbsp;&nbsp;因此为了实现动作的流畅，我们使用了动画混合空间和动画蒙太奇。在 UE 的动画系统框架下，动画混合空间成为了构建流畅动作过渡的关键要素。通过精心设置混合空间的参数与维度，例如以角色的移动速度、转向角度等作为变量，我们能够在不同的动画片段之间实现无缝且自然的融合。当角色从静止状态逐渐加速奔跑时，混合空间可以依据角色当前的速度值，精准地在站立动画、行走动画以及奔跑动画之间进行平滑过渡，使动作的变化连贯流畅，毫无突兀之感。
## （二）攻击功能
&nbsp;&nbsp;&nbsp;&nbsp;在玩家的普通武器攻击实现过程中，充分借助 UE 中的 Kismet System Library 进行范围性检测。先依据游戏场景需求，利用该库设定特定形状与大小的检测范围，如圆形、矩形或自定义多边形区域等，以此确定可能受攻击影响的空间范围。当玩家触发攻击操作时，系统在设定范围内进行目标筛选，通过碰撞检测机制识别出处于该范围内的帕鲁。一旦锁定目标，便调用帕鲁的受伤函数接口，并依据玩家武器的攻击力属性以及与帕鲁之间可能存在的属性克制关系，通过复杂的伤害计算公式得出实际伤害值，将其传递给帕鲁的受伤函数，从而实现对帕鲁生命值的削减，完成一次普通武器攻击流程，且整个过程确保攻击判定的准确性与高效性。  
&nbsp;&nbsp;&nbsp;&nbsp;对于帕鲁球捕捉帕鲁的功能，同样依托 UE 引擎特性构建实现逻辑。将帕鲁球设定为特殊的攻击武器形式，在玩家投掷帕鲁球后，创建独立的检测与处理流程。利用多线程技术确保帕鲁球飞行过程中的检测与游戏主线程互不干扰，在飞行期间持续进行位置更新与碰撞检测。若帕鲁球与帕鲁发生碰撞且满足捕捉条件，如特定的距离范围、角度要求以及帕鲁的当前状态等综合判定成功后，直接将帕鲁的血量清零，达成捕捉即 “击杀” 的效果；若不满足捕捉条件，判定为捕捉失败，此时伤害值设为 0。并且，为避免帕鲁球在场景中无限存在，设置定时器来控制其生命周期，在规定时间到达后自动销毁帕鲁球并释放相关资源，维持游戏场景的资源平衡与运行流畅性。
## （三）攀爬功能
&nbsp;&nbsp;&nbsp;&nbsp;在攀爬功能的实现上，主要借助 UE 中的内置射线检测机制。当玩家靠近潜在的攀爬对象时，射线检测启动，对前方物体进行扫描与分析，判断其是否高于预设的固定倾角，若满足条件，则将该物体判定为可供攀爬的墙面。在攀爬过程中，射线持续工作，只要一直检测到墙壁，攀爬动作便会持续进行。同时，为确保攀爬动作的精准性、连贯性以及稳定性，构建了一个二维混合空间。通过该混合空间，玩家在墙壁上能够实现上下左右四个方位的灵活移动，其根据玩家输入的方向指令，对不同方向的攀爬动画进行平滑融合与过渡，使得角色在攀爬时的运动姿态更为自然流畅，极大地增强了玩家在攀爬场景中的操作体验与视觉感受，为游戏中的探索与移动增添了更多的可能性与趣味性。
## （四）砍树和挖矿功能
&nbsp;&nbsp;&nbsp;&nbsp;在砍树和挖矿功能的实现中，充分运用 UE 基础交互功能构建人物与地图固定资产的互动逻辑。当人物对树或矿石模型发起攻击时，通过碰撞检测机制精准捕捉交互动作，随即触发预先设定的粒子特效，逼真地模拟出砍树时木屑飞溅、挖矿时碎石迸射的场景效果。随着攻击的持续，系统依据设定的伤害数值体系对树和矿石的血量进行计算，当树的血量削减至特定阈值，便会触发倒地动画，以直观的视觉呈现宣告砍树成功；同理，矿石在遭受攻击达到相应血量损耗后，会播放碎裂动画，生动展现被开采的过程，整个流程紧密结合视觉特效与逻辑判断，让人物与世界的交互显得自然且富有沉浸感。
## （五）建造功能
&nbsp;&nbsp;&nbsp;&nbsp;在建造功能的实现中，充分运用 UE 基础交互功能构建人物与地图区块的互动逻辑。当人物靠近地图上特定的可建造区域时，触发机制创建一个建造菜单或者建造物品栏界面。此界面利用 UE 的 UMG 系统精心设计，具备直观清晰的布局与视觉效果，玩家可以在其中便捷地选择想要建造的具体建筑、道具等对象。这些建造对象预先制作成 UE 中的蓝图类，每个蓝图类全面且详细地定义了该建造对象的外观、材质纹理、物理属性、功能作用以及建造所需的资源种类与数量等关键属性。当玩家在界面中选中一个建造对象后，点击确认按钮或执行特定的确认交互操作，系统便进入准备放置该对象的状态。此时，人物角色再次与地图区块交互时，后台开始依据复杂的算法与逻辑判断所选对象能否放置在对应的区块上。这一判断过程涵盖对地形类型、空间高度、周边已有建筑的碰撞检测以及资源是否充足等多方面因素的考量。例如，若建造对象为一座高塔，系统会检查放置区域的地形平整度、高度限制以及是否有足够的空间避免与其他建筑发生碰撞冲突，同时确认玩家拥有建造该高塔所需的特定资源，如石材、木材等。只有当所有条件均满足时，才会在地图区块上成功放置建造对象，完成建造效果的呈现，为玩家提供丰富且具有深度的建造体验，极大地拓展了游戏的创造性与趣味性。
## 四、帕鲁相关创新技术实现
### （一）动画与模型设计
&nbsp;&nbsp;&nbsp;&nbsp;帕鲁的动画机制与精致模型是其魅力所在。在动画设计方面，为帕鲁创建了多种动画状态，如行走、奔跑、跳跃、攻击、防御、休息、受惊等，每种状态都有独立的蒙太奇动画设计，这些动画通过精心设计的关键帧和过渡效果，生动地展现了帕鲁的行为特征。动画状态机的设计与实现代码约250行，用于管理帕鲁在不同情境下的动画切换与播放，确保动画的流畅性和连贯性。同时通过线上资源获得了许多可供参考精美模型，实现整活自创模型的设计与导入，为游戏增添了独特的趣味性与创意元素。
### （二）AI 基础机制
&nbsp;&nbsp;&nbsp;&nbsp;帕鲁的 AI 巡逻机制基于UE内置的一些寻路机制。在本游戏的 AI 控制系统中，各类控制器起着至关重要的作用，共同构建起智能且复杂的 AI 行为体系。其中一个核心控制器在游戏开启的初始阶段，首要任务是获取与之紧密关联的角色对象。一旦成功获取到对应的角色，便会激活预先精心设计与配置的行为树机制。此行为树犹如 AI 角色的大脑中枢，涵盖了丰富多样的行为模式与决策流程，从基础的移动指令到复杂的交互动作触发，均在其规划与调控范围内，从而为 AI 角色赋予了在游戏世界中自主行动与应对的基础能力，使其能够有条不紊地执行诸如常规巡逻等基础任务，并依据不同情境做出初步的反应与抉择。  
&nbsp;&nbsp;&nbsp;&nbsp;另一个关键控制器在其初始化构建过程中，专门创建了用于感知外界环境信息的特定组件。这一组件就像是 AI 角色的感官器官，为其收集周围环境中的各类关键信息提供了可能。当游戏正式启动并进入运行状态后，该控制器会先对一些关键数据进行初始化设定，为后续精确的感知判断奠定基础。同时，它会将感知信息更新事件与专门的处理函数进行紧密绑定，构建起一条高效的信息处理通道。  
&nbsp;&nbsp;&nbsp;&nbsp;每当感知信息更新事件被触发时，相应的处理函数便会迅速启动并开始运作。首先，它会精准地识别并获取自身角色以及被感知到的其他角色对象。为避免出现错误判断，会对所获取的角色进行严格筛选与甄别，排除掉自身角色以免造成不必要的干扰。随后，借助角色自身携带的关键属性信息，通过一套严谨且智能的判断逻辑，确定被感知角色与自身的关系属性，判断其是否为敌对目标。只有当确定为敌对目标后，才会进一步对该目标与自身的相对位置关系进行深入分析与计算，通过比较与筛选，确定出距离自身最近的敌对目标。最后，会与 AI 信息交互与存储的核心组件进行对接，在确保该组件正常运作的前提下，将有关最近敌对目标的关键信息及时更新到其中，以便其他相关的 AI 决策模块能够依据这些最新信息，制定出更为精准、高效的应对策略，例如在攻击时能够灵活调整攻击方式与强度，追击时能够准确锁定目标并优化追击路径等，从而极大地提升了 AI 角色在游戏中的智能决策水平与复杂交互能力，为玩家带来更具挑战性与趣味性的游戏体验。
### （三）帕鲁 AI 逻辑深化 - 细节处理
&nbsp;&nbsp;&nbsp;&nbsp;在帕鲁 AI 逻辑深化的细节处理方面，主要借助蒙太奇动画加行为树来实现。帕鲁的感知系统通过行为树中的节点设置与逻辑连接，实现对周围环境的高效感知与判断。例如，利用行为树中的 “感知范围” 节点来确定帕鲁能够察觉敌人的距离范围，通过调整该节点的参数，可以灵活控制帕鲁的感知灵敏度。  
&nbsp;&nbsp;&nbsp;&nbsp;当帕鲁检测到敌方时，触发受惊动画的逻辑通过行为树与蒙太奇动画的协同工作实现。行为树中的 “条件判断” 节点检测到敌方存在后，发送信号激活蒙太奇动画中的受惊动画序列。帕鲁巡逻时间计数器与休息动画触发机制同样整合在行为树中，通过 “时间判断” 节点累计巡逻时间，当达到预设值时，触发休息动画的播放，并调整帕鲁的行为状态。  
&nbsp;&nbsp;&nbsp;&nbsp;帕鲁之间相互攻击的阵营标签区分与攻击逻辑在行为树中有详细的设计。为每个帕鲁设置阵营标签，并在行为树的决策分支中加入阵营判断逻辑，根据目标的位置、距离、自身状态等因素制定攻击策略，。在帕鲁追击目标时，距离计算与目标更新机制，实时计算帕鲁与周围敌方单位之间的距离，并根据距离变化调整追击目标，确保帕鲁能够在战斗中做出合理的战术决策。
### （四）帕鲁 AI 逻辑深化 – 动态生成与销毁与其他方面
&nbsp;&nbsp;&nbsp;&nbsp;在帕鲁 AI 逻辑深化的动态生成与销毁，于地图特定地点生成敌人的触发器设置上，利用 UE 的蓝图系统创建触发器 Actor，在其蓝图逻辑中，依据位置信息、玩家状态或游戏进程等条件编写触发条件判断代码，当条件满足时，通过生成 Actor 的函数调用来在指定地点生成敌人，此部分涉及到较多的条件判断与 Actor 生成相关代码。  
&nbsp;&nbsp;&nbsp;&nbsp;对于 boss 的创建与生成，在 UE 中设计专门的 boss 生成管理器类，该类负责 boss 的初始化设置，包括加载 boss 模型、设置属性、关联 AI 行为树等。在游戏流程达到特定阶段或满足特定触发条件时，由该管理器类执行生成操作。该boss支持触发器生成和地下城boss通关两种游戏打法，游戏模式灵活，游戏玩法和游戏难度多种多样。  
&nbsp;&nbsp;&nbsp;&nbsp;在远程攻击实现方面，借助 UE 的射线检测功能，在帕鲁的 AI 控制蓝图或 C++ 代码中，当发起远程攻击指令时，发射射线并检测射线碰撞结果以确定攻击目标。同时，利用定时器或时间轴功能设置延迟效果，在延迟期间玩家可通过移动操作改变位置，从而有机会躲开攻击。射线检测与延迟效果的控制代码以及与攻击逻辑的整合部分代码相对较多，需精细处理以确保远程攻击的准确性、平衡性与可躲避性。
## 五、成员分工
| 成员 | 分工 | 详细描述 |
| :--- | :--- | :--- |
| 王冠杰 | 帕鲁攻击及相关动作和AI的设计 | 构建帕鲁的攻击体系，设计多种攻击方式的实现机制，如近战攻击的攻击范围判定、伤害数值计算、攻击动画序列，远程攻击的发射角度与力度控制、飞行轨迹模拟、目标命中检测，以及攻击动作与特效的配合，同时平衡攻击与玩家防御机制之间的关系。  主要实现的类如下：  <br>AEnemyBaseCharacter类(帕鲁基类)  <br>ASoldier1Character类(敌人与boss基类)  <br>AEnemyAIController(帕鲁ai逻辑类) <br>ACharacterAnimInstance类(帕鲁动画类)  <br>USoliderTaskAttackPlayer类(攻击节点类)  <br>USoliderTaskGetRandomPosition类(获取随机地点类)  <br>UTaskRestNode类(休息动画节点类)  <br>USoliderTaskflee类(逃跑节点类)  <br>USoliderTaskGetRandomPosition类(修改速度类) <br>USoliderHealthWidget类(挂载血条控件类) <br>UCombatGameMode类(敌人创建控制类) <br>UCreateSoliderPoint类(帕鲁创建点生成类) <br>UCreateEnemyPoint类(敌人创建生成点类) |
| 王明昱 | 帕鲁细节逻辑及相关动作和AI的设计 | 专注于帕鲁的非攻击相关逻辑细节设计，包括帕鲁的外观特征设计与优化，定义帕鲁的性格特点并将其融入到行为模式中，设计帕鲁的 AI 行为逻辑，如巡逻路径规划、对玩家或其他游戏元素的感知与反应、不同阵营帕鲁之间相互识别并且攻击、特殊事件触发时的行为表现等。主要实现的类如下：  <br>ABasePalCharacter类(帕鲁基类)  <br>APalAIController类(帕鲁ai逻辑类)  <br>APalSupermaleAIController(另一种ai逻辑类)<br>APalAnimInstance类(帕鲁动画类)  <br>UTaskAttackNode类(攻击节点类)  <br>UTaskEncounterNode类(偶遇动画节点类)  <br>UTaskGetRandomPositionNode类(获取随机地点类)  <br>UTaskRestNode类(休息动画节点类)  <br>UTaskReviseIsFirstEncounterNode类(偶遇节点处理类)  <br>UTaskRevisePlayerNode类(修改攻击对象类)  <br>UTaskReviseSpeedNode类(修改速度类)   |
| 郭骏豪 | 有关玩家细节的设计 | 负责玩家角色的细节塑造，包括角色模型的精细化构建与优化，设计玩家的各种动作细节，如移动、战斗、交互动作等，确保动作的自然流畅与真实感，同时处理玩家与游戏环境中各种物体交互时的细节反馈，如碰撞音效、拾取物品动画等。 |
| 王鹤桥 | 地图图形整体界面设计与 UI 处理 | 设计游戏地图的整体图形展示，包括地形、建筑等元素的视觉呈现，创建并优化地图相关的各类用户界面，如地图信息面板、场景切换按钮等，保障地图与 UI 之间的交互流畅性与视觉协调性，除此之外还实现了通过联机功能，不仅支持steam联机的功能，还支持通过局域网创建房间的功能 |
| 喻晨轲 | 主 UI 设计与处理 | 专注于游戏主界面的设计开发，确定主界面的布局结构、色彩风格，制作主界面的功能图标与按钮，编写主界面与游戏核心功能模块的交互逻辑代码，例如游戏启动流程、设置选项的交互响应、存档读取与保存操作等。 |
## 六、结语
&nbsp;&nbsp;&nbsp;&nbsp;通过本次基于 UE 开发的游戏项目实践，我们深入探索了程序设计在游戏开发领域的多方面应用。从主世界的联机、存档、天气时间系统与地图构建，到玩家丰富的交互功能，再到帕鲁 AI 的深度设计，每个环节都紧密相连，构成了一个复杂而有序的游戏生态。在代码编写过程中，我们严格遵循程序设计范式，注重代码的模块化、可复用性与可读性，尽管过程中遭遇诸多挑战，如各种复杂算法的实现、不同系统间的整合协调，但也正是这些难题促使我们不断钻研，大幅提升了代码编写能力。  
&nbsp;&nbsp;&nbsp;&nbsp;在课程大作业的背景下，我们深刻认识到程序设计范式对于大型项目开发的重要性。它犹如灯塔，指引我们在代码的海洋中规范前行，避免陷入混乱与低效的泥沼。我们学会了如何运用面向对象编程思想合理构建类与对象关系，利用设计模式优化系统架构，以高效的方式解决实际问题。此次实践不仅让我们完成了一个功能丰富的游戏作品，更让我们对程序设计有了全新的感悟与理解，为未来在游戏开发及其他编程领域的深入探索奠定了坚实的基础，我们将带着这些宝贵经验，在程序设计的道路上不断前行，追求更高的代码品质与设计境界。
